<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Matches</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-md relative">
    <div class="max-w-7xl mx-auto px-4 py-3 relative flex items-center justify-center">
      <p onclick="window.location.href='add-match.html'" class="absolute left-4 text-gray-700 cursor-pointer">
        <i class="fas fa-arrow-left text-2xl"></i>
      </p>
      <h1 class="text-xl font-bold text-gray-800">All Matches</h1>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <section>
      <div id="tasksList" class="space-y-4" role="list" aria-live="polite">
        <p class="text-center text-indigo-500 italic">Loading matches...</p>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      deleteDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDooTNeDHoWUU9nLxYxyBIhewydt7Xl_M0",
      authDomain: "dlstournament-31ac1.firebaseapp.com",
      projectId: "dlstournament-31ac1",
      storageBucket: "dlstournament-31ac1.appspot.com",
      messagingSenderId: "874377019055",
      appId: "1:874377019055:web:6e38db2ec7f0d541d2de5a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const tasksCol = collection(db, "tasks");
    const tasksList = document.getElementById("tasksList");

    function showToast(message, icon = "success") {
      Swal.fire({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        icon: icon,
        title: message,
      });
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        Swal.fire({
          icon: "warning",
          title: "Please log in first.",
          confirmButtonText: "OK"
        }).then(() => {
          window.location.href = "login.html";
        });
        return;
      }
      loadTasksRealtime();
    });

    function loadTasksRealtime() {
      onSnapshot(tasksCol, (snapshot) => {
        if (snapshot.empty) {
          tasksList.innerHTML = '<p class="text-center text-indigo-500 italic">No matches found.</p>';
          return;
        }

        tasksList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const task = { id: docSnap.id, ...docSnap.data() };

          const taskDiv = document.createElement("div");
          taskDiv.className = "p-6 bg-white rounded-2xl shadow-lg flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4";

          const info = document.createElement("div");
          info.className = "flex-1 min-w-0";
          info.innerHTML = `
            <p class="text-lg font-semibold text-indigo-700 truncate">${task.name}</p>
            <p class="text-sm text-gray-600 mt-1">${task.description || ""}</p>
            <p class="mt-2 font-medium text-indigo-600">Team One: ${task.reward || ""}</p>
            ${task.view ? `<p class="mt-1">Team Two: ${task.view}</p>` : ""}
          `;

          const controls = document.createElement("div");
          controls.className = "flex gap-2 sm:gap-3";

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl text-white transition shadow-md focus:outline-none focus:ring-2 focus:ring-red-400";
          deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete`;
          deleteBtn.title = "Delete Match";
          deleteBtn.onclick = async () => {
            if (confirm(`Delete match "${task.name}"? This action cannot be undone.`)) {
              try {
                await deleteDoc(doc(db, "tasks", task.id));
                showToast("Match deleted.");
              } catch (error) {
                showToast("Error deleting match: " + error.message, "error");
              }
            }
          };

          controls.appendChild(deleteBtn);

          taskDiv.appendChild(info);
          taskDiv.appendChild(controls);
          tasksList.appendChild(taskDiv);
        });
      });
    }
  </script>
</body>
</html>
