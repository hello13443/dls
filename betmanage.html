<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bet Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-md relative">
    <div class="max-w-7xl mx-auto px-4 py-3 relative flex items-center justify-center">
      <p onclick="window.location.href='admin.html'" class="absolute left-4 text-gray-700 cursor-pointer">
        <i class="fas fa-arrow-left text-2xl"></i>
      </p>
      <h1 class="text-xl font-bold text-gray-800">Bet Manager</h1>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <section>
      <div id="tasksList" class="space-y-4" role="list" aria-live="polite">
        <p class="text-center text-indigo-500 italic">Loading matches...</p>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      updateDoc,
      deleteDoc,
      onSnapshot,
      arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDooTNeDHoWUU9nLxYxyBIhewydt7Xl_M0",
      authDomain: "dlstournament-31ac1.firebaseapp.com",
      projectId: "dlstournament-31ac1",
      storageBucket: "dlstournament-31ac1.appspot.com",
      messagingSenderId: "874377019055",
      appId: "1:874377019055:web:6e38db2ec7f0d541d2de5a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const tasksCol = collection(db, "tasks");
    const tasksList = document.getElementById("tasksList");

    function showToast(message, icon = "success") {
      Swal.fire({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        icon: icon,
        title: message,
      });
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        Swal.fire({
          icon: "warning",
          title: "Please log in first.",
          confirmButtonText: "OK"
        }).then(() => {
          window.location.href = "login.html";
        });
        return;
      }
      loadTasksRealtime();
    });

    function loadTasksRealtime() {
      onSnapshot(tasksCol, (snapshot) => {
        if (snapshot.empty) {
          tasksList.innerHTML = '<p class="text-center text-indigo-500 italic">No matches found.</p>';
          return;
        }

        tasksList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const task = { id: docSnap.id, ...docSnap.data() };

          const taskDiv = document.createElement("div");
          taskDiv.className = "p-6 bg-white rounded-2xl shadow-lg flex flex-col gap-4";
          taskDiv.id = `task-${task.id}`;

          const info = document.createElement("div");
          info.innerHTML = `
            <p class="text-lg font-semibold text-indigo-700 truncate">${task.name}</p>
            <p class="text-sm text-gray-600 mt-1">${task.description || ""}</p>
            <div class="mt-3 text-base font-medium text-gray-800">
              <span class="text-green-600">${task.reward || "Team One"}</span>
              <span class="mx-2 font-bold text-gray-500">vs</span>
              <span class="text-red-600">${task.view || "Team Two"}</span>
            </div>
            <div class="mt-3 space-y-1" id="options-${task.id}">
              ${(task.options || []).map(opt => `
                <div class="text-sm text-gray-700 border p-2 rounded-md">
                  <strong>${opt.title}</strong><br>
                  ${opt.one} (${opt.pointOne}) vs ${opt.two} (${opt.pointTwo})
                </div>
              `).join('')}
            </div>
          `;

          const controls = document.createElement("div");
          controls.className = "flex flex-wrap gap-2";

          const addOptionBtn = document.createElement("button");
          addOptionBtn.className = "bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-xl text-white";
          addOptionBtn.innerHTML = `<i class="fas fa-plus-circle mr-1"></i> Add Option`;
          addOptionBtn.onclick = () => {
            if (taskDiv.querySelector(".option-form")) return;

            const form = document.createElement("div");
            form.className = "option-form mt-4 bg-gray-100 p-4 rounded-xl space-y-2";

            form.innerHTML = `
              <input type="text" placeholder="Option Title" class="w-full px-3 py-2 rounded border border-gray-300" id="title-${task.id}">
              <input type="text" placeholder="Option One" class="w-full px-3 py-2 rounded border border-gray-300" id="one-${task.id}">
              <input type="text" placeholder="Option Two" class="w-full px-3 py-2 rounded border border-gray-300" id="two-${task.id}">
              <input type="number" placeholder="Point One" class="w-full px-3 py-2 rounded border border-gray-300" id="pointOne-${task.id}">
              <input type="number" placeholder="Point Two" class="w-full px-3 py-2 rounded border border-gray-300" id="pointTwo-${task.id}">
              <div class="flex gap-2">
                <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="addOption('${task.id}')">Add</button>
                <button class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded" onclick="this.closest('.option-form').remove()">Cancel</button>
              </div>
            `;
            taskDiv.appendChild(form);
          };

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl text-white";
          deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete`;
          deleteBtn.onclick = async () => {
            if (confirm(`Delete match "${task.name}"?`)) {
              try {
                await deleteDoc(doc(db, "tasks", task.id));
                showToast("Match deleted.");
              } catch (error) {
                showToast("Error: " + error.message, "error");
              }
            }
          };

          controls.appendChild(addOptionBtn);
          controls.appendChild(deleteBtn);

          taskDiv.appendChild(info);
          taskDiv.appendChild(controls);
          tasksList.appendChild(taskDiv);
        });
      });
    }

    window.addOption = async function(taskId) {
      const title = document.getElementById(`title-${taskId}`).value.trim();
      const one = document.getElementById(`one-${taskId}`).value.trim();
      const two = document.getElementById(`two-${taskId}`).value.trim();
      const pointOne = parseFloat(document.getElementById(`pointOne-${taskId}`).value.trim());
      const pointTwo = parseFloat(document.getElementById(`pointTwo-${taskId}`).value.trim());

      if (!title || !one || !two || isNaN(pointOne) || isNaN(pointTwo)) {
        showToast("Please fill in all fields.", "warning");
        return;
      }

      const option = { title, one, two, pointOne, pointTwo };

      try {
        await updateDoc(doc(db, "tasks", taskId), {
          options: arrayUnion(option)
        });
        showToast("Option added.");

        // Add to UI instantly
        const optionsDiv = document.getElementById(`options-${taskId}`);
        const optHTML = document.createElement("div");
        optHTML.className = "text-sm text-gray-700 border p-2 rounded-md";
        optHTML.innerHTML = `
          <strong>${title}</strong><br>
          ${one} (${pointOne}) vs ${two} (${pointTwo})
        `;
        optionsDiv.appendChild(optHTML);

        // Remove form
        document.getElementById(`title-${taskId}`).closest('.option-form').remove();
      } catch (error) {
        showToast("Failed to add option.", "error");
        console.error(error);
      }
    };
  </script>
</body>
</html>
